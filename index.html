<!DOCTYPE html>
<html lang="en">
    
<script src="flashcards_AgileOld.js"></script>
<script src="flashcards_CV.js"></script>
<script src="flashcards_Agile.js"></script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Flashcards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            /* background: linear-gradient(45deg, #3144a1 0%, #792dc4 100%); */
            background: linear-gradient(45deg, #000000 0%, #000000 100%);
            min-height: 100vh;
            padding: 0 20px 20px 20px;
            color: #333;
            font-size: 1.6rem;
        }
        .p {
            font-size: 4rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            margin-top: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 6px;
            color: white;
            padding-top: 18px;
            padding-bottom: 0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header > div, .header p {
            margin-top: 0;
            margin-bottom: 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 30px;
        }

        .flashcard {
            width: 100%;
            min-height: 45vh;
            /* height: 400px; */
            position: relative;
            cursor: pointer;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            top: 0;
            left: 0;
            transition: opacity 0.05s linear;
            pointer-events: auto !important;
        }

        .card-front {
            background: #fff;
            color: #222;
            border: 2px solid #e0e0e0;
            opacity: 1;
            z-index: 2;
        }

        .card-back {
            background: #fff;
            color: #222;
            border: 6px solid #4CAF50;
            opacity: 0;
            z-index: 1;
        }
        .flashcard.flipped .card-front {
            opacity: 0;
        }
        .flashcard.flipped .card-back {
            opacity: 1;
        }

        .card-content h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .card-content p, .card-content ul, .card-content div {
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: left;
        }

        .card-content ul {
            padding-left: 20px;
        }

        .card-content li {
            margin-bottom: 8px;
        }

        .progress {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
            cursor: pointer;
            /* user-select: none; removed to prevent inheritance issues */
            position: relative;
            width: 100%;
        }

        .progress-bar {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 20px;
            border-radius: 6px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .category-tag {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .formula {
            background: rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .flashcard {
                height: 400px;
            }
            
            .card-face {
                padding: 20px;
            }
            
            .card-content h2 {
                font-size: 1.5rem;
            }
            
            .controls {
                gap: 10px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .stats {
                justify-content: center !important;
                min-width: 0 !important;
            }
            .filter-section {
                flex-direction: column;
                gap: 10px;
                padding: 8px 8px;
            }
            .mode-toggle {
                margin-left: 0;
            }
            .stats-row {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            #categoryTag {
                margin-bottom: 10px;
                text-align: center;
            }
            #categoryFilter {
                font-size: 0.95rem;
                min-width: 0;
                width: 100%;
                max-width: 260px;
                margin: 0 auto;
            }
        }

        .filter-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin-bottom: 18px;
            margin-top: 0;
            background: rgba(255,255,255,0.10);
            border-radius: 12px;
            padding: 10px 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .filter-label {
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            margin-right: 4px;
        }
        #categoryFilter {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            background: #262a45;
            color: #fff;
            outline: none;
            min-width: 160px;
        }
        .mode-toggle {
            display: flex;
            gap: 6px;
            margin-left: 18px;
        }
        .mode-btn {
            padding: 7px 18px;
            border: none;
            border-radius: 18px;
            font-size: 1rem;
            font-weight: 600;
            background: #41446b;
            color: #fff;
            cursor: pointer;
            opacity: 0.7;
            transition: background 0.2s, opacity 0.2s;
        }
        .mode-btn.active {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            opacity: 1;
            box-shadow: 0 2px 10px rgba(33,150,243,0.15);
        }
        #restartBtn {
            min-width: 100px;
        }
        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                gap: 10px;
                padding: 8px 8px;
            }
            .mode-toggle {
                margin-left: 0;
            }
        }

        /* palette overlay */
        #qpOverlay{
            position:fixed;inset:0;backdrop-filter:blur(2px);
            background:rgba(0,0,0,.35);display:none;z-index:999;
        }
        /* palette window */
        #qpBox{
            position:absolute;left:50%;top:4%;transform:translateX(-50%);
            width:min(900px,98%);max-width:900px;background:#262a45;border-radius:14px;
            box-shadow:0 12px 32px rgba(0,0,0,.45);padding:28px 28px 20px 28px;color:#fafafa;
            min-height: 200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* input */
        #qpInput{
            width:100%;padding:10px 12px;font-size:16px;
            border:none;border-radius:6px;background:#15182a;color:#fff;
            outline:none;
            flex: 0 0 auto;
        }
        /* results list */
        #qpResults{
            margin:12px 0 0;
            flex: 1 1 auto;
            min-height: 0;
            max-height: none;
            overflow-y: auto;
        }
        .qp-item{
            padding:8px 12px;border-radius:6px;cursor:pointer;
            display:flex;justify-content:space-between;gap:8px;
            align-items: flex-start;
        }
        .qp-item .qp-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        .qp-item strong {
            display: block;
            font-size: 1.5rem;
            word-break: break-word;
            white-space: normal;
        }
        .qp-cat {
            font-size: 12px;
            opacity: .6;
            margin-bottom: 4px;
        }
        .qp-item:hover,.qp-item.active{background:#41446b}
        .qp-num{opacity:.6;font-size:14px}

        .card-content, .card-content * {
            user-select: text !important;
        }
        #backContent, #backContent * {
            user-select: text !important;
            pointer-events: auto !important;
        }

        /* Force answer text selectable */
        .card-back, .card-back *, #backContent, #backContent * {
            user-select: auto !important;
        }

        .stats-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #categoryTag {
            /* existing styles */
        }
        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                gap: 10px;
                padding: 8px 8px;
            }
            .mode-toggle {
                margin-left: 0;
            }
            .stats-row {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            #categoryTag {
                margin-bottom: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Custom UNI Flashcards üéì</h1>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <p style="margin: 0;">CITS 4402/CITS 3403</p>
                <label id="uploadIconLabel" title="Paste Flashcards JSON" style="cursor:pointer;display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.12);border-radius:50%;padding:7px;transition:background 0.2s;">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </label>
                <button id="infoIconBtn" aria-label="Show info/help" title="Show info/help" style="cursor:pointer;display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.12);border:none;border-radius:50%;padding:7px;transition:background 0.2s;outline:none;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>
                </button>
            </div>
            <div id="uploadError" style="color:#ffb300; font-size:1rem; margin-top:6px; min-height:1.2em;"></div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FILTERS & MODE TOGGLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div class="filter-section">
            <label for="categoryFilter" class="filter-label">Category:</label>
            <select id="categoryFilter"></select>
            <div class="mode-toggle">
                <button id="orderedBtn" class="mode-btn active">Ordered</button>
                <button id="shuffledBtn" class="mode-btn">Shuffled</button>
            </div>
        </div>
        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ END FILTERS & MODE TOGGLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
        </div>

        <div class="stats-row" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <div class="category-tag" id="categoryTag">Loading...</div>
            <div class="stats" style="display: flex; justify-content: flex-end; gap: 30px; min-width: 320px;">
                <div class="stat">
                    <span class="stat-number" id="currentCard">1</span>
                    <span>Current</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="totalCards">0</span>
                    <span>Total</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="correctAnswers">0</span>
                    <span>Correct</span>
                </div>
            </div>
        </div>

        <div class="flashcard-container">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <div class="card-content" id="frontContent">
                        <h2>Click to start studying!</h2>
                        <p>Press "Next Card" to begin your review session.</p>
                    </div>
                </div>
                <div class="card-face card-back">
                    <div class="card-content" id="backContent">
                        <h2>Answer</h2>
                        <p>Click the card to flip it back, or use the navigation buttons.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-warning" id="restartBtn" onclick="restartCards()">üîÑ Restart</button>
            <button class="btn btn-secondary" onclick="previousCard()">‚Üê Previous</button>
            <button class="btn btn-primary" onclick="flipCard()">Flip Card</button>
            <button class="btn btn-secondary" onclick="nextCard()">Next ‚Üí</button>
            <button class="btn btn-warning" onclick="markCorrect()">‚úì Got It!</button>
        </div>
    </div>

    <!-- Info Modal Overlay -->
    <div id="infoModalOverlay" style="display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,0.45);backdrop-filter:blur(2px);justify-content:center;align-items:center;">
      <div id="infoModal" style="background:#262a45;color:#fafafa;max-width:50vw;width:50vw;max-height:50vh;padding:32px 28px 22px 28px;border-radius:14px;box-shadow:0 12px 32px rgba(0,0,0,.45);position:relative;overflow:auto;">
        <button id="closeInfoModal" aria-label="Close info" style="position:absolute;top:12px;right:12px;background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer;opacity:0.7;">&times;</button>
        <h2 style="margin-top:0;font-size:1.5rem;">üí° How to Use This Flashcard App</h2>
        <ul style="margin:12px 0 0 0;padding:0 0 0 18px;font-size:1.08rem;line-height:1.7;">
          <li><strong>Flashcard Navigation:</strong>
            <ul style="margin:4px 0 8px 0;padding-left:18px;font-size:1rem;">
              <li><kbd>‚Üê</kbd> Previous card</li>
              <li><kbd>‚Üí</kbd> or <kbd>Space</kbd> Next card</li>
              <li><kbd>‚Üë</kbd> / <kbd>‚Üì</kbd> Flip card (show/hide answer)</li>
              <li><kbd>Enter</kbd> Mark current card as <em>Correct</em></li>
              <li>On <strong>mobile</strong>: tap the card to flip</li>
              <li>On <strong>desktop</strong>: use buttons or keyboard (clicking the card does not flip)</li>
            </ul>
          </li>
          <li><strong>Progress Bar:</strong> Click or drag anywhere on the progress bar above the cards to instantly jump to any card in the current set.</li>
          <li><strong>Category Filtering:</strong> Use the <b>Category</b> dropdown to study cards from a specific lecture/topic, or select "All Categories" to review everything.</li>
          <li><strong>Ordered & Shuffled Modes:</strong> Switch between studying cards in their original order or in a random order using the <b>Ordered</b> and <b>Shuffled</b> buttons. The <b>Restart</b> button resets your session and reshuffles if in shuffled mode.</li>
          <li><strong>Quick-Find Command Palette:</strong>
            <ul style="margin:4px 0 8px 0;padding-left:18px;font-size:1rem;">
              <li>Open with <kbd>‚åò</kbd>+<kbd>K</kbd> (Mac) or <kbd>Ctrl</kbd>+<kbd>K</kbd> (Windows/Linux)</li>
              <li>Type <code>#57</code> to jump to card 57</li>
              <li>Type keywords to live-search by question, answer, or category</li>
              <li>Use <kbd>‚Üë</kbd>/<kbd>‚Üì</kbd> to navigate results, <kbd>Enter</kbd> to jump, <kbd>Esc</kbd> to close</li>
            </ul>
          </li>
          <li><strong>Uploading Custom Flashcards:</strong> Click the <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> icon next to the title to upload your own flashcards in JSON format. This will <b>replace all current cards</b> and update the category list. Paste or upload a valid JSON array of objects with <code>category</code>, <code>question</code>, and <code>answer</code> fields. Invalid files will show an error.</li>
          <li><strong>Preloaded Flashcards:</strong> To access the preloaded Agile or Computer Vision flashcards, simply change the JSON file name in the index using the "Inspect Element" tool in your browser. This allows you to quickly switch between different sets of flashcards without needing to upload new files manually.</li>
          <li><strong>Text Selection:</strong> You can select and copy any text from the question or answer sides of a flashcard, including formulas and lists, for use in other apps or LLMs.</li>
          <li><strong>Responsive Design:</strong> The app is fully responsive and works on both desktop and mobile devices. Controls and interactions adapt to your device.</li>
          <li><strong>Accessibility:</strong> All controls are keyboard accessible. Modals and palettes can be closed with <kbd>Esc</kbd> or by clicking outside.</li>
          <li><strong>Session Stats:</strong> The stats panel below the progress bar shows your current card number, total cards, and how many you have marked as correct.</li>
          <li><strong>Flashcard Format:</strong> Example JSON for upload:<br><code>[ { "category": "Lecture2(ImageBasics)", "question": "...", "answer": "..." }, ... ]</code></li>
        </ul>
        <div style="margin-top:18px;font-size:0.98rem;opacity:0.8;">For best results, generate flashcards using the provided format. All features work instantly after upload‚Äîno refresh needed.</div>
      </div>
    </div>

    <div id="uploadJsonModalOverlay" style="display:none;position:fixed;inset:0;z-index:3000;background:rgba(0,0,0,0.45);backdrop-filter:blur(2px);justify-content:center;align-items:center;">
      <div id="uploadJsonModal" style="background:#262a45;color:#fafafa;max-width:480px;width:95vw;padding:32px 32px 24px 32px;border-radius:14px;box-shadow:0 12px 32px rgba(0,0,0,.45);position:relative;">
        <button id="closeUploadJsonModal" aria-label="Close upload" style="position:absolute;top:12px;right:12px;background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer;opacity:0.7;">&times;</button>
        <h2 style="margin-top:0;font-size:1.3rem;">Paste Flashcards JSON</h2>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:8px 0;">
          <label for="templateSelect" style="color:#fafafa;font-size:1rem;">Prompt Template:</label>
          <select id="templateSelect" style="padding:6px 12px;border-radius:6px;font-size:1rem;background:#15182a;color:#fff;border:none;outline:none;">
            <option value="DeepContent" selected>Exam-Style (HTML, detailed)</option>
            <option value="MCQs">Multiple Choice</option>
            <option value="ComputerVision">Computer Vision Template</option>
            <option value="AgileWebDev">Agile Web Development Template</option>
          </select>
        </div>
        <textarea id="uploadJsonTextarea" rows="10" style="width:100%;border-radius:8px;padding:16px;font-size:1.08rem;background:#15182a;color:#fff;border:none;resize:vertical;margin-top:16px;max-height:300px;overflow-y:auto;"></textarea>
        <div id="uploadJsonError" style="color:#ffb300; font-size:1rem; margin-top:8px; min-height:1.2em;"></div>
        <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:18px;">
          <button id="cancelUploadJsonBtn" class="btn btn-secondary" style="padding:8px 18px;font-size:1rem;">Cancel</button>
          <button id="submitUploadJsonBtn" class="btn btn-primary" style="padding:8px 18px;font-size:1rem;">Load Flashcards</button>
        </div>
      </div>
    </div>

    <script>

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FILTERING & MODE STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentIndex = 0;
        let isFlipped = false;
        let correctCount = 0;
        let mode = 'ordered'; // 'ordered' or 'shuffled'
        let selectedCategory = 'All Categories';
        let filteredCards = [];
        let orderedCards = [...flashcards];
        let shuffledCards = [];

        // Populate category dropdown
        function populateCategoryDropdown() {
            const select = document.getElementById('categoryFilter');
            const categories = Array.from(new Set(flashcards.map(f => f.category)));
            categories.sort();
            select.innerHTML = '<option>All Categories</option>' +
                categories.map(cat => `<option>${cat}</option>`).join('');
        }

        // Filter cards by category
        function filterCards() {
            if (selectedCategory === 'All Categories') {
                orderedCards = [...flashcards];
            } else {
                orderedCards = flashcards.filter(f => f.category === selectedCategory);
            }
            shuffledCards = shuffleArray([...orderedCards]);
            filteredCards = (mode === 'shuffled') ? shuffledCards : orderedCards;
            currentIndex = 0;
            correctCount = 0;
            updateDisplay();
        }

        // Shuffle helper
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // Mode switching
        function setMode(newMode) {
            if (mode === newMode) return;
            mode = newMode;
            document.getElementById('orderedBtn').classList.toggle('active', mode === 'ordered');
            document.getElementById('shuffledBtn').classList.toggle('active', mode === 'shuffled');
            filteredCards = (mode === 'shuffled') ? shuffledCards : orderedCards;
            currentIndex = 0;
            correctCount = 0;
            updateDisplay();
        }

        // Restart button logic
        function restartCards() {
            if (mode === 'shuffled') {
                shuffledCards = shuffleArray([...orderedCards]);
                filteredCards = shuffledCards;
            } else {
                filteredCards = orderedCards;
            }
            currentIndex = 0;
            correctCount = 0;
            updateDisplay();
        }

        // Update display
        function updateDisplay() {
            if (filteredCards.length === 0) {
                document.getElementById('frontContent').innerHTML = '<h2>No cards</h2><p>No flashcards in this category.</p>';
                document.getElementById('backContent').innerHTML = '';
                document.getElementById('categoryTag').textContent = '';
                document.getElementById('currentCard').textContent = '0';
                document.getElementById('totalCards').textContent = '0';
                document.getElementById('correctAnswers').textContent = correctCount;
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressBar').textContent = '0%';
                return;
            }
            const card = filteredCards[currentIndex];
            document.getElementById('frontContent').innerHTML = `
                <h2>Question ${currentIndex + 1}</h2>
                <p>${card.question}</p>
            `;
            document.getElementById('backContent').innerHTML = `
                <h2>Answer</h2>
                <div style="text-align: left;">${card.answer.replace(/\n/g, '<br>')}</div>
            `;
            document.getElementById('categoryTag').textContent = card.category;
            document.getElementById('currentCard').textContent = currentIndex + 1;
            document.getElementById('totalCards').textContent = filteredCards.length;
            document.getElementById('correctAnswers').textContent = correctCount;
            const progress = ((currentIndex + 1) / filteredCards.length) * 100;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            if (isFlipped) {
                document.getElementById('flashcard').classList.remove('flipped');
                isFlipped = false;
            }
            adjustFlashcardHeight();
        }

        function adjustFlashcardHeight () {
            const wrapper   = document.getElementById('flashcard');
            const frontH    = document.getElementById('frontContent').scrollHeight;
            const backH     = document.getElementById('backContent').scrollHeight;
            const targetH   = Math.max(frontH, backH) + 60; // add buffer
            wrapper.style.height = targetH + 'px';
        }

        function flipCard() {
            if (filteredCards.length === 0) return;
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
            adjustFlashcardHeight();
        }

        function nextCard() {
            if (filteredCards.length === 0) return;
            if (currentIndex < filteredCards.length - 1) {
                currentIndex++;
                updateDisplay();
            } else {
                alert('üéâ Congratulations! You\'ve completed all flashcards!\n\nScore: ' + correctCount + '/' + filteredCards.length);
            }
        }

        function previousCard() {
            if (filteredCards.length === 0) return;
            if (currentIndex > 0) {
                currentIndex--;
                updateDisplay();
            }
        }

        function markCorrect() {
            if (filteredCards.length === 0) return;
            correctCount++;
            updateDisplay();
            setTimeout(nextCard, 500);
        }

        // Event listeners
        // Only allow click-to-flip on mobile
        function isMobile() {
            return window.innerWidth <= 768;
        }
        const flashcardElem = document.getElementById('flashcard');
        function setFlashcardClickListener() {
            if (isMobile()) {
                flashcardElem.addEventListener('click', flipCard);
                flashcardElem.style.cursor = 'pointer';
            } else {
                flashcardElem.removeEventListener('click', flipCard);
                flashcardElem.style.cursor = 'default';
            }
        }
        window.addEventListener('resize', setFlashcardClickListener);
        window.addEventListener('DOMContentLoaded', function() {
            populateCategoryDropdown();
            filterCards();
            document.getElementById('orderedBtn').classList.add('active');
            document.getElementById('shuffledBtn').classList.remove('active');
            setFlashcardClickListener();
        });

        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            selectedCategory = e.target.value;
            filterCards();
        });
        document.getElementById('orderedBtn').addEventListener('click', function() { setMode('ordered'); });
        document.getElementById('shuffledBtn').addEventListener('click', function() { setMode('shuffled'); });

        document.addEventListener('keydown', function(event) {
            if (qpOverlay && qpOverlay.style.display === 'block') return;
            if (filteredCards.length === 0) return;
            switch(event.key) {
                case 'ArrowLeft':
                    previousCard();
                    break;
                case 'ArrowRight':
                    nextCard();
                    break;
                case ' ':
                    flipCard();
                    break;
                case 'ArrowUp':
                case 'ArrowDown':
                    flipCard();
                    break;
                // case 'Enter':
                //     markCorrect();
                //     break;
            }
        });

        // --- Drag-to-scroll for progress bar ---
        const progressBarContainer = document.querySelector('.progress');
        const progressBar = document.getElementById('progressBar');

        let isDraggingProgress = false;

        progressBarContainer.addEventListener('mousedown', function(e) {
            isDraggingProgress = true;
            handleProgressDrag(e);
        });
        window.addEventListener('mousemove', function(e) {
            if (isDraggingProgress) handleProgressDrag(e);
        });
        window.addEventListener('mouseup', function() {
            isDraggingProgress = false;
        });

        // For touch devices
        progressBarContainer.addEventListener('touchstart', function(e) {
            isDraggingProgress = true;
            handleProgressDrag(e.touches[0]);
        });
        window.addEventListener('touchmove', function(e) {
            if (isDraggingProgress) handleProgressDrag(e.touches[0]);
        });
        window.addEventListener('touchend', function() {
            isDraggingProgress = false;
        });

        // Add click event for instant jump
        progressBarContainer.addEventListener('click', function(e) {
            handleProgressDrag(e);
        });

        function handleProgressDrag(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            const percent = x / rect.width;
            if (filteredCards.length > 0) {
                const newIndex = Math.floor(percent * (filteredCards.length - 1));
                if (newIndex !== currentIndex) {
                    currentIndex = newIndex;
                    updateDisplay();
                }
            }
        }

        // --- Upload JSON Modal Logic ---
        const uploadIconLabel = document.getElementById('uploadIconLabel');
        const uploadJsonModalOverlay = document.getElementById('uploadJsonModalOverlay');
        const uploadJsonModal = document.getElementById('uploadJsonModal');
        const closeUploadJsonModal = document.getElementById('closeUploadJsonModal');
        const uploadJsonTextarea = document.getElementById('uploadJsonTextarea');
        const uploadJsonError = document.getElementById('uploadJsonError');
        const cancelUploadJsonBtn = document.getElementById('cancelUploadJsonBtn');
        const submitUploadJsonBtn = document.getElementById('submitUploadJsonBtn');

        function openUploadJsonModal() {
const example = `Generate 20 flashcards for my exam with difficult questions from the uploaded lecture material.
Target my understanding of complex topics and how they tie together, not just rote learning but testing my true understanding. Give sufficiently detailed answers for an exam. 
Output exactly in the following JSON format, with each card as an object with keys: category, question, and answer. Group all questions from the same lecture into the same category name.

The "answer" field must contain clean, valid HTML embedded inside a JSON string. Follow these formatting rules strictly:
- Escape all double quotes, always have a back slash before a "
- Do NOT use \\n or other escaped newlines unless part of an HTML tag (e.g., <br>).
- Make full and thoughtful use of HTML formatting to improve clarity and structure:
  - Use <p> for paragraphs
  - Use <ul>, <ol>, and <li> for lists
  - Use <strong> or <em> to emphasize key ideas
  - Use <code> for inline code or tag names
- Avoid plain text blobs. Structure answers to be skimmable and readable.
- Do NOT include comments, markdown, or extra output‚Äîonly return a valid JSON array.

Example output:
[
  {
    "category": "Lecture1(HTML Basics)",
    "question": "What is the purpose of the <code>&lt;head&gt;</code> tag in HTML?",
    "answer": "<p>The <code>&lt;head&gt;</code> tag contains metadata and links to scripts, stylesheets, and other resources needed before rendering the body of the document.</p>"
  },
  {
    "category": "Lecture1(HTML Basics)",
    "question": "Explain the difference between <code>&lt;div&gt;</code> and semantic tags.",
    "answer": "<ul><li><strong>&lt;div&gt;:</strong><ul><li>Non-semantic, used purely for layout or styling.</li><li>Flexible, but less informative to assistive technologies.</li></ul></li><li><strong>Semantic tags (e.g., &lt;main&gt;, &lt;nav&gt;, &lt;section&gt;):</strong><ul><li>Semantic meaning improves accessibility and search visibility.</li><li>Encourages cleaner, more maintainable structure.</li></ul></li><li><strong>Trade-off:</strong><ul><li>Divs are easier when layout logic dominates.</li><li>Semantic tags require thoughtful use but offer long-term clarity and benefits.</li></ul></li></ul>"}]`

        
        if (!uploadJsonTextarea.value.trim()) uploadJsonTextarea.value = example;
            uploadJsonError.textContent = '';
            uploadJsonModalOverlay.style.display = 'flex';
            setTimeout(() => uploadJsonTextarea.focus(), 100);
        }
        function closeUploadJson() {
            uploadJsonModalOverlay.style.display = 'none';
            uploadIconLabel.focus();
        }
        if (uploadIconLabel && uploadJsonModalOverlay && closeUploadJsonModal && uploadJsonTextarea && uploadJsonError && cancelUploadJsonBtn && submitUploadJsonBtn) {
            uploadIconLabel.addEventListener('click', openUploadJsonModal);
            uploadIconLabel.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openUploadJsonModal();
                }
            });
            closeUploadJsonModal.addEventListener('click', closeUploadJson);
            cancelUploadJsonBtn.addEventListener('click', closeUploadJson);
            uploadJsonModalOverlay.addEventListener('click', function(e) {
                if (e.target === uploadJsonModalOverlay) closeUploadJson();
            });
            window.addEventListener('keydown', function(e) {
                if (uploadJsonModalOverlay.style.display === 'flex' && e.key === 'Escape') closeUploadJson();
            });
            submitUploadJsonBtn.addEventListener('click', function() {
                uploadJsonError.textContent = '';
                let text = uploadJsonTextarea.value.trim();
                if (!text) {
                    uploadJsonError.textContent = 'Paste your flashcards JSON.';
                    return;
                }
                try {
                    const data = JSON.parse(text);
                    if (Array.isArray(data) && data.every(card => card && typeof card === 'object' && 'category' in card && 'question' in card && 'answer' in card)) {
                        flashcards.length = 0;
                        data.forEach(card => flashcards.push(card));
                        selectedCategory = 'All Categories';
                        populateCategoryDropdown();
                        filterCards();
                        uploadJsonError.style.color = '#4CAF50';
                        uploadJsonError.textContent = 'Flashcards loaded!';
                        setTimeout(closeUploadJson, 700);
                    } else {
                        uploadJsonError.textContent = 'Invalid format: must be an array of {category, question, answer} objects.';
                        uploadJsonError.style.color = '#ffb300';
                    }
                } catch (err) {
                    uploadJsonError.textContent = 'Invalid JSON.';
                    uploadJsonError.style.color = '#ffb300';
                }
            });
        }

        // JS: Info modal logic
        const infoIconBtn = document.getElementById('infoIconBtn');
        const infoModalOverlay = document.getElementById('infoModalOverlay');
        const closeInfoModal = document.getElementById('closeInfoModal');
        if (infoIconBtn && infoModalOverlay && closeInfoModal) {
            function openInfoModal() {
                infoModalOverlay.style.display = 'flex';
                closeInfoModal.focus();
            }
            function closeInfo() {
                infoModalOverlay.style.display = 'none';
                infoIconBtn.focus();
            }
            infoIconBtn.addEventListener('click', openInfoModal);
            infoIconBtn.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openInfoModal();
                }
            });
            closeInfoModal.addEventListener('click', closeInfo);
            infoModalOverlay.addEventListener('click', function(e) {
                if (e.target === infoModalOverlay) closeInfo();
            });
            window.addEventListener('keydown', function(e) {
                if (infoModalOverlay.style.display === 'flex' && e.key === 'Escape') closeInfo();
            });
        }

        const templateExamples = {
            DeepContent: `Generate 20 flashcards for my exam with difficult questions from the uploaded lecture material.\nTarget my understanding of complex topics and how they tie together, not just rote learning but testing my true understanding. Give sufficiently detailed answers for an exam. \nOutput exactly in the following JSON format, with each card as an object with keys: category, question, and answer. Group all questions from the same lecture into the same category name.\n\nThe "answer" field must contain clean, valid HTML embedded inside a JSON string. Follow these formatting rules strictly:\n- Escape all double quotes (use back slash).\n- Do NOT use \\n or other escaped newlines unless part of an HTML tag (e.g., <br>).\n- Make full and thoughtful use of HTML formatting to improve clarity and structure:\n  - Use <p> for paragraphs\n  - Use <ul>, <ol>, and <li> for lists\n  - Use <strong> or <em> to emphasize key ideas\n  - Use <code> for inline code or tag names\n- Avoid plain text blobs. Structure answers to be skimmable and readable.\n- Do NOT include comments, markdown, or extra output‚Äîonly return a valid JSON array.\n\nExample output:\n[\n  {\n    "category": "Lecture1(HTML Basics)",\n    "question": "What is the purpose of the <code>&lt;head&gt;</code> tag in HTML?",\n    "answer": "<p>The <code>&lt;head&gt;</code> tag contains metadata and links to scripts, stylesheets, and other resources needed before rendering the body of the document.</p>"\n  },\n  {\n    "category": "Lecture1(HTML Basics)",\n    "question": "Explain the difference between <code>&lt;div&gt;</code> and semantic tags.",\n    "answer": "<ul><li><strong>&lt;div&gt;:</strong><ul><li>Non-semantic, used purely for layout or styling.</li><li>Flexible, but less informative to assistive technologies.</li></ul></li><li><strong>Semantic tags (e.g., &lt;main&gt;, &lt;nav&gt;, &lt;section&gt;):</strong><ul><li>Semantic meaning improves accessibility and search visibility.</li><li>Encourages cleaner, more maintainable structure.</li></ul></li><li><strong>Trade-off:</strong><ul><li>Divs are easier when layout logic dominates.</li><li>Semantic tags require thoughtful use but offer long-term clarity and benefits.</li></ul></li></ul>"}]`,
            MCQs: `Generate 20 difficult flashcards for my exam with tricky multiple choice style questions from the uploaded lecture material.\nTarget my understanding of complex topics and how they tie together, not just rote learning but testing my true understanding. Give sufficiently detailed answers for an exam. \nOutput exactly in the following JSON format, with each card as an object with keys: category, question, and answer. Group all questions from the same lecture into the same category name.\n\nThe "answer" field must contain clean, valid HTML embedded inside a JSON string. Follow these formatting rules strictly:\n- Escape all double quotes (use back slash).\n- Do NOT use \\n or other escaped newlines unless part of an HTML tag (e.g., <br>).\n- Make full and thoughtful use of HTML formatting to improve clarity and structure:\n  - Use <p> for paragraphs\n  - Use <ul>, <ol>, and <li> for lists\n  - Use <strong> or <em> to emphasize key ideas\n  - Use <code> for inline code or tag names\n- Avoid plain text blobs. Structure answers to be skimmable and readable.\n- Do NOT include comments, markdown, or extra output‚Äîonly return a valid JSON array.\n\nExample output:\n[\n  {\n    "category": "Lecture1(HTML Basics)",\n    "question": "What is the purpose of the <code>&lt;head&gt;</code> tag in HTML?",\n    "answer": "<p>The <code>&lt;head&gt;</code> tag contains metadata and links to scripts, stylesheets, and other resources needed before rendering the body of the document.</p>"\n  },\n  {\n    "category": "Lecture1(HTML Basics)",\n    "question": "Explain the difference between <code>&lt;div&gt;</code> and semantic tags.",\n    "answer": "<ul><li><strong>&lt;div&gt;:</strong><ul><li>Non-semantic, used purely for layout or styling.</li><li>Flexible, but less informative to assistive technologies.</li></ul></li><li><strong>Semantic tags (e.g., &lt;main&gt;, &lt;nav&gt;, &lt;section&gt;):</strong><ul><li>Semantic meaning improves accessibility and search visibility.</li><li>Encourages cleaner, more maintainable structure.</li></ul></li><li><strong>Trade-off:</strong><ul><li>Divs are easier when layout logic dominates.</li><li>Semantic tags require thoughtful use but offer long-term clarity and benefits.</li></ul></li></ul>"}]`,
            ComputerVision: 
`Generate a comprehensive flashcard for every numbered point in the document "Lecture 02 - What you need to know.pdf". Rely (as much as possible) solely on the material in the lecture slides.
Add 5 extra flashcards to target my understanding of complex topics and how they tie together to test my understanding. Give sufficiently detailed answers for an exam. 
Output exactly in the following JSON format, with each card as an object with keys: category, question, and answer. Group all questions from the same lecture into the same category name.

The "answer" field must contain clean, valid HTML embedded inside a JSON string. Follow these formatting rules strictly:
- Escape all double quotes, always have a back slash before a "
- Do NOT use \\n or other escaped newlines unless part of an HTML tag (e.g., <br>).
- Make full and thoughtful use of HTML formatting to improve clarity and structure:
  - Use <p> for paragraphs
  - Use <ul>, <ol>, and <li> for lists
  - Use <strong> or <em> to emphasize key ideas
  - Use <code> for inline code or tag names
- Avoid plain text blobs. Structure answers to be skimmable and readable.
- Do NOT include comments, markdown, or extra output‚Äîonly return a valid JSON array.

Example output:
[
  {
    "category": "Lecture1(HTML Basics)",
    "question": "What is the purpose of the <code>&lt;head&gt;</code> tag in HTML?",
    "answer": "<p>The <code>&lt;head&gt;</code> tag contains metadata and links to scripts, stylesheets, and other resources needed before rendering the body of the document.</p>"
  },
  {
    "category": "Lecture1(HTML Basics)",
    "question": "Explain the difference between <code>&lt;div&gt;</code> and semantic tags.",
    "answer": "<ul><li><strong>&lt;div&gt;:</strong><ul><li>Non-semantic, used purely for layout or styling.</li><li>Flexible, but less informative to assistive technologies.</li></ul></li><li><strong>Semantic tags (e.g., &lt;main&gt;, &lt;nav&gt;, &lt;section&gt;):</strong><ul><li>Semantic meaning improves accessibility and search visibility.</li><li>Encourages cleaner, more maintainable structure.</li></ul></li><li><strong>Trade-off:</strong><ul><li>Divs are easier when layout logic dominates.</li><li>Semantic tags require thoughtful use but offer long-term clarity and benefits.</li></ul></li></ul>"}]`,
AgileWebDev:`Generate comprehensive flashcards for my exam, targeting the uploaded lecture material. Give sufficiently detailed answers for an exam.

Fully prepare me for all of the following topics, and have at least one flashcard for each point below.

Lecture 4
‚Ä¢ Purpose of CSS frameworks
‚Ä¢ What is meant by a ‚Äúresponsive design‚Äù
You will not be expected to read, write or fix Bootstrap code.
Lecture 5
‚Ä¢ Purpose of JavaScript
‚Ä¢ How JavaScript can be used in the browser
‚Ä¢ All of the language features covered in the lecture.
You are expected to be able to read and fix JavaScript code, but you will not be expected to
write it.
Lecture 6
‚Ä¢ The purpose and overall structure of the DOM (but not the keywords)
‚Ä¢ The purpose and overall structure of the BOM
‚Ä¢ The different ways that the DOM may be used to edit the page (again, you do not
have to remember the specific keywords)
‚Ä¢ Web storage and cookies
‚Ä¢ Purpose and structure of event driven programming
‚Ä¢ How event driven programming is implemented in the browser, i.e. event
registration, event flow
‚Ä¢ Understand the purpose of some common events
‚Ä¢ Purpose of JQuery
‚Ä¢ You are expected to be able to read and fix JavaScript DOM/BOM code, but you will not be
expected to write it. You will not be expected to read, fix or write JQuery code.

Output exactly in the following JSON format, with each card as an object with keys: category, question, and answer. Group all questions from the same lecture into the same category name.

The "answer" field must contain clean, valid HTML embedded inside a JSON string. Follow these formatting rules strictly:
- Escape all double quotes, always have a back slash before a "
- Do NOT use \\n or other escaped newlines unless part of an HTML tag (e.g., <br>).
- Make full and thoughtful use of HTML formatting to improve clarity and structure:
  - Use <p> for paragraphs
  - Use <ul>, <ol>, and <li> for lists
  - Use <strong> or <em> to emphasize key ideas
  - Use <code> for inline code or tag names
- Avoid plain text blobs. Structure answers to be skimmable and readable.
- Do NOT include comments, markdown, or extra output‚Äîonly return a valid JSON array.

Example output:
[
  {
    "category": "Lecture1(HTML Basics)",
    "question": "What is the purpose of the <code>&lt;head&gt;</code> tag in HTML?",
    "answer": "<p>The <code>&lt;head&gt;</code> tag contains metadata and links to scripts, stylesheets, and other resources needed before rendering the body of the document.</p>"
  },
  {
    "category": "Lecture1(HTML Basics)",
    "question": "Explain the difference between <code>&lt;div&gt;</code> and semantic tags.",
    "answer": "<ul><li><strong>&lt;div&gt;:</strong><ul><li>Non-semantic, used purely for layout or styling.</li><li>Flexible, but less informative to assistive technologies.</li></ul></li><li><strong>Semantic tags (e.g., &lt;main&gt;, &lt;nav&gt;, &lt;section&gt;):</strong><ul><li>Semantic meaning improves accessibility and search visibility.</li><li>Encourages cleaner, more maintainable structure.</li></ul></li><li><strong>Trade-off:</strong><ul><li>Divs are easier when layout logic dominates.</li><li>Semantic tags require thoughtful use but offer long-term clarity and benefits.</li></ul></li></ul>"}]`

};
        const templateSelect = document.getElementById('templateSelect');
        if (templateSelect) {
          templateSelect.addEventListener('change', function() {
            uploadJsonTextarea.value = templateExamples[this.value] || '';
          });
          // Set default template on modal open
          function setDefaultTemplate() {
            templateSelect.value = 'DeepContent';
            uploadJsonTextarea.value = templateExamples['DeepContent'] || '';
          }
          // Patch openUploadJsonModal to set default template
          const origOpenUploadJsonModal = openUploadJsonModal;
          window.openUploadJsonModal = function() {
            setDefaultTemplate();
            origOpenUploadJsonModal();
          };
        }
    </script>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ QUICK-FIND COMMAND-PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<style>
    /* palette overlay */
    #qpOverlay{
        position:fixed;inset:0;backdrop-filter:blur(2px);
        background:rgba(0,0,0,.35);display:none;z-index:999;
    }
    /* palette window */
    #qpBox{
        position:absolute;left:50%;top:4%;transform:translateX(-50%);
        width:min(900px,98%);max-width:900px;background:#262a45;border-radius:14px;
        box-shadow:0 12px 32px rgba(0,0,0,.45);padding:28px 28px 20px 28px;color:#fafafa;
        min-height: 200px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    /* input */
    #qpInput{
        width:100%;padding:10px 12px;font-size:16px;
        border:none;border-radius:6px;background:#15182a;color:#fff;
        outline:none;
        flex: 0 0 auto;
    }
    /* results list */
    #qpResults{margin:12px 0 0;flex: 1 1 auto;min-height: 0;max-height: none;overflow-y: auto}
    .qp-item{
        padding:4px 8px;border-radius:6px;cursor:pointer;
        display:flex;justify-content:space-between;gap:8px;
        align-items: flex-start;
    }
    .qp-item .qp-main {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
    }
    .qp-item strong {
        display: block;
        font-size: 1.1rem;
        word-break: break-word;
        white-space: normal;
    }
    .qp-cat {
        font-size: 12px;
        opacity: .6;
        margin-bottom: 4px;
    }
    .qp-item:hover,.qp-item.active{background:#41446b}
    .qp-num{opacity:.6;font-size:14px}
</style>
    
    <div id="qpOverlay">
      <div id="qpBox">
          <input id="qpInput" placeholder="Type #number or keywords ‚Ä¶">
          <div id="qpResults"></div>
      </div>
    </div>
    
    <script>
    /* ---------- Quick-Find Palette ---------- */
    const qpOverlay  = document.getElementById('qpOverlay');
    const qpInput    = document.getElementById('qpInput');
    const qpResults  = document.getElementById('qpResults');
    let   qpItems    = [];         // DOM nodes for results
    let   qpActiveIx = -1;         // keyboard highlight index
    
    /* open palette (Ctrl/‚åò+K) */
    function openPalette(){
        buildResults("");          // empty query shows first N cards
        qpOverlay.style.display='block';
        qpInput.focus(); 
    }
    function closePalette(){
        qpOverlay.style.display='none';
        qpInput.value="";
        qpResults.innerHTML="";
        qpActiveIx=-1;
    }
    
    /* fuzzy search helper */
    function matches(card, q){
        const s=(card.question+" "+card.category+" "+card.answer).toLowerCase();
        return s.includes(q);
    }
    
    /* build results list */
    function buildResults(query){
        qpResults.innerHTML="";
        qpItems=[]; qpActiveIx=-1;
        let results=[];
        if(/^#?\d+$/.test(query)){          // number search
            const idx=parseInt(query.replace('#',''))-1;
            if(idx>=0 && idx<filteredCards.length) results.push({idx,card:filteredCards[idx]});
        }else{
            const q=query.toLowerCase();
            filteredCards.forEach((c,i)=>{ if(matches(c,q)) results.push({idx:i,card:c}); });
        }
        if(results.length===0){ qpResults.innerHTML="<div style='opacity:.6;padding:8px'>No match</div>"; return;}
        results.forEach((r,i)=>{
            const div=document.createElement('div');
            div.className='qp-item';
            div.innerHTML=`
                <span class="qp-main">
                    <strong>${r.card.question}</strong>
                    <span class="qp-cat">${r.card.category}</span>
                </span>
                <span class="qp-num">#${r.idx+1}</span>
            `;
            div.onclick=()=>jumpTo(r.idx);
            qpResults.appendChild(div);
            qpItems.push(div);
            if(i===0){div.classList.add('active'); qpActiveIx=0;}
        });
    }
    
    /* jump to card */
    function jumpTo(idx){
        currentIndex=idx;
        updateDisplay();
        closePalette();
    }
    
    /* handle palette key events */
    qpInput.addEventListener('input', e=>buildResults(e.target.value));
    qpInput.addEventListener('keydown', e=>{
        const max=qpItems.length-1;
        if(e.key==="ArrowDown"){ e.preventDefault(); if(qpActiveIx<max){qpItems[qpActiveIx]?.classList.remove('active'); qpActiveIx++; qpItems[qpActiveIx].classList.add('active'); qpItems[qpActiveIx].scrollIntoView({block:'nearest'});} }
        if(e.key==="ArrowUp"){   e.preventDefault(); if(qpActiveIx>0){qpItems[qpActiveIx]?.classList.remove('active'); qpActiveIx--; qpItems[qpActiveIx].classList.add('active'); qpItems[qpActiveIx].scrollIntoView({block:'nearest'});} }
        if(e.key==="Enter"){     e.preventDefault(); if(qpActiveIx>-1) qpItems[qpActiveIx].click(); }
        if(e.key==="Escape"){ closePalette(); }
    });
    
    /* global shortcut listener */
    document.addEventListener('keydown',e=>{
        // Always trigger for Cmd/Ctrl+K, even if focus is on input, select, or button
        if ((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k') {
            e.preventDefault();
            e.stopPropagation();
            openPalette();
            return false;
        }
    }, true); // Use capture phase to ensure it fires before other handlers
    
    /* click outside to close */
    qpOverlay.addEventListener('click',e=>{ if(e.target===qpOverlay) closePalette(); });
    
    /* allow long-press on title (mobile) */
    document.querySelector('h1, h2')?.addEventListener('contextmenu',e=>{e.preventDefault(); openPalette();});

    // Block other shortcuts when palette is open, but allow typing in the input
    document.addEventListener('keydown', function(e) {
        if (qpOverlay.style.display === 'block' && e.target !== qpInput) {
            // Allow navigation/close keys, block others
            const allowed = ['ArrowUp','ArrowDown','Enter','Escape'];
            if (!allowed.includes(e.key)) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
    }, true);
    </script>
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ END COMMAND-PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    
</body>
